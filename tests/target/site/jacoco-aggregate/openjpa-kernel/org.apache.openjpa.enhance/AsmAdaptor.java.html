<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="it"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>AsmAdaptor.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Tests</a> &gt; <a href="../index.html" class="el_bundle">openjpa-kernel</a> &gt; <a href="index.source.html" class="el_package">org.apache.openjpa.enhance</a> &gt; <span class="el_source">AsmAdaptor.java</span></div><h1>AsmAdaptor.java</h1><pre class="source lang-java linenums">/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * &quot;License&quot;); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */
package org.apache.openjpa.enhance;

import static java.util.Arrays.asList;

import java.io.BufferedInputStream;
import java.io.ByteArrayInputStream;
import java.io.ByteArrayOutputStream;
import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.net.URLDecoder;

import org.apache.xbean.asm8.ClassReader;
import org.apache.xbean.asm8.ClassVisitor;
import org.apache.xbean.asm8.ClassWriter;
import org.apache.xbean.asm8.Opcodes;

import serp.bytecode.BCClass;


/**
 * Use ASM to add required StackMapTable attribute to the byte code generated by
 * Serp.
 */
<span class="nc" id="L45">public final class AsmAdaptor {</span>
<span class="nc bnc" id="L46" title="All 2 branches missed.">    private static final boolean USE_ASM = System.getProperty(&quot;java.version&quot;).compareTo(&quot;1.6&quot;) &gt; 0;</span>
    private static final int Java7_MajorVersion = 51;

    @SuppressWarnings(&quot;deprecation&quot;)
    public static void write(BCClass bc) throws IOException {
<span class="nc bnc" id="L51" title="All 2 branches missed.">        if (bc.getMajorVersion() &lt; Java7_MajorVersion) {</span>
<span class="nc" id="L52">            bc.write();</span>
        } else {
<span class="nc" id="L54">            String name = bc.getName();</span>
<span class="nc" id="L55">            int dotIndex = name.lastIndexOf('.') + 1;</span>
<span class="nc" id="L56">            name = name.substring(dotIndex);</span>
<span class="nc" id="L57">            Class&lt;?&gt; type = bc.getType();</span>

<span class="nc" id="L59">            OutputStream out = new FileOutputStream(</span>
<span class="nc" id="L60">                    URLDecoder.decode(type.getResource(name + &quot;.class&quot;).getFile()));</span>
            try {
<span class="nc" id="L62">                writeJava7(bc, out);</span>
            } finally {
<span class="nc" id="L64">                out.flush();</span>
<span class="nc" id="L65">                out.close();</span>
            }
        }
<span class="nc" id="L68">    }</span>

    public static void write(BCClass bc, File outFile) throws IOException {
<span class="nc bnc" id="L71" title="All 2 branches missed.">        if (bc.getMajorVersion() &lt; Java7_MajorVersion) {</span>
<span class="nc" id="L72">            bc.write(outFile);</span>
        } else {
<span class="nc" id="L74">            OutputStream out = new FileOutputStream(outFile);</span>
            try {
<span class="nc" id="L76">                writeJava7(bc, out);</span>
            } finally {
<span class="nc" id="L78">                out.flush();</span>
<span class="nc" id="L79">                out.close();</span>
            }
        }
<span class="nc" id="L82">    }</span>

    public static void write(BCClass bc, OutputStream os) throws IOException {
<span class="nc bnc" id="L85" title="All 2 branches missed.">        if (bc.getMajorVersion() &lt; Java7_MajorVersion) {</span>
<span class="nc" id="L86">            bc.write(os);</span>
        }
        else {
            try {
<span class="nc" id="L90">                writeJava7(bc, os);</span>
            } finally {
<span class="nc" id="L92">                os.flush();</span>
<span class="nc" id="L93">                os.close();</span>
            }
        }
<span class="nc" id="L96">    }</span>

    public static byte[] toByteArray(BCClass bc, byte[] returnBytes) throws IOException {
<span class="nc bnc" id="L99" title="All 2 branches missed.">        if (bc.getMajorVersion() &gt;= Java7_MajorVersion) {</span>
<span class="nc" id="L100">            returnBytes = toJava7ByteArray(bc, returnBytes);</span>
        }
<span class="nc" id="L102">        return returnBytes;</span>
    }

    private static void writeJava7(BCClass bc, OutputStream out) throws IOException {
<span class="nc" id="L106">        byte[] java7Bytes = toJava7ByteArray(bc, bc.toByteArray());</span>
<span class="nc" id="L107">        out.write(java7Bytes);</span>
<span class="nc" id="L108">    }</span>

    private static byte[] toJava7ByteArray(BCClass bc, byte[] classBytes) throws IOException {
<span class="nc" id="L111">        ByteArrayInputStream bais = new ByteArrayInputStream(classBytes);</span>
<span class="nc" id="L112">        BufferedInputStream bis = new BufferedInputStream(bais);</span>

<span class="nc" id="L114">        ClassWriter cw = new BCClassWriter(ClassWriter.COMPUTE_FRAMES, bc.getClassLoader());</span>
<span class="nc" id="L115">        ClassReader cr = new ClassReader(bis);</span>
<span class="nc" id="L116">        cr.accept(cw, 0);</span>
<span class="nc" id="L117">        return cw.toByteArray();</span>
    }

    public static boolean use()
    {
<span class="nc" id="L122">        return USE_ASM;</span>
    }

    public static boolean isEnhanced(final byte[] b)
    {
<span class="nc bnc" id="L127" title="All 2 branches missed.">        if (b == null)</span>
        {
<span class="nc" id="L129">            return false;</span>
        }
<span class="nc" id="L131">        final ClassReader cr = new ClassReader(b);</span>
        try
        {
<span class="nc" id="L134">            cr.accept(new ClassVisitor(Opcodes.ASM8)</span>
<span class="nc" id="L135">            {</span>
                @Override
                public void visit(final int i, final int i1,
                                  final String name, final String s,
                                  final String parent, final String[] interfaces)
                {
<span class="nc bnc" id="L141" title="All 4 branches missed.">                    boolean enhanced = interfaces != null &amp;&amp; interfaces.length &gt; 0 &amp;&amp;</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">                        asList(interfaces).contains(&quot;org/apache/openjpa/enhance/PersistenceCapable&quot;);</span>
<span class="nc bnc" id="L143" title="All 6 branches missed.">                    if (!enhanced &amp;&amp; name != null &amp;&amp; parent != null &amp;&amp;</span>
<span class="nc bnc" id="L144" title="All 4 branches missed.">                        !&quot;java/lang/Object&quot;.equals(parent) &amp;&amp; !name.equals(parent)) {</span>
<span class="nc" id="L145">                        enhanced = isEnhanced(bytes(parent));</span>
                    }
<span class="nc" id="L147">                    throw new EnhancedStatusException(enhanced);</span>
                }
            }, 0);
<span class="nc" id="L150">            return false;</span>
<span class="nc" id="L151">        } catch (final EnhancedStatusException e) {</span>
<span class="nc" id="L152">            return e.status;</span>
<span class="nc" id="L153">        } catch (final Exception e) {</span>
<span class="nc" id="L154">            return false;</span>
        }
    }

    private static byte[] bytes(final String type)
    {
<span class="nc" id="L160">        final ByteArrayOutputStream baos = new ByteArrayOutputStream(1024);</span>
<span class="nc" id="L161">        final InputStream stream = Thread.currentThread().getContextClassLoader()</span>
<span class="nc" id="L162">            .getResourceAsStream(type + &quot;.class&quot;);</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">        if (stream == null) {</span>
<span class="nc" id="L164">            return null;</span>
        }
        try {
            int c;
<span class="nc" id="L168">            byte[] buffer = new byte[1024];</span>
<span class="nc bnc" id="L169" title="All 2 branches missed.">            while ((c = stream.read(buffer)) &gt;= 0) {</span>
<span class="nc" id="L170">                baos.write(buffer, 0, c);</span>
            }
<span class="nc" id="L172">        } catch (IOException e) {</span>
<span class="nc" id="L173">            return null;</span>
        } finally {
            try {
<span class="nc" id="L176">                stream.close();</span>
<span class="nc" id="L177">            } catch (IOException e) {</span>
                // no-op
<span class="nc" id="L179">            }</span>
        }
<span class="nc" id="L181">        return baos.toByteArray();</span>
    }

    private static class BCClassWriter extends ClassWriter {
        private final ClassLoader _loader;

        BCClassWriter(int flags, ClassLoader loader) {
<span class="nc" id="L188">            super(flags);</span>
<span class="nc" id="L189">            _loader = loader;</span>
<span class="nc" id="L190">        }</span>

        @Override
        protected String getCommonSuperClass(String type1, String type2) {
            Class&lt;?&gt; class1;
            Class&lt;?&gt; class2;
            try {
<span class="nc" id="L197">                class1 = _loader.loadClass(type1.replace('/', '.'));</span>
<span class="nc" id="L198">                class2 = _loader.loadClass(type2.replace('/', '.'));</span>
<span class="nc" id="L199">            } catch (ClassNotFoundException ex) {</span>
<span class="nc" id="L200">                throw new RuntimeException(ex);</span>
<span class="nc" id="L201">            }</span>
<span class="nc bnc" id="L202" title="All 2 branches missed.">            if (class1.isAssignableFrom(class2)) {</span>
<span class="nc" id="L203">                return type1;</span>
            }
<span class="nc bnc" id="L205" title="All 2 branches missed.">            if (class2.isAssignableFrom(class1)) {</span>
<span class="nc" id="L206">                return type2;</span>
            }
<span class="nc bnc" id="L208" title="All 4 branches missed.">            if (class1.isInterface() || class2.isInterface()) {</span>
<span class="nc" id="L209">                return &quot;java/lang/Object&quot;;</span>
            }
            do {
<span class="nc" id="L212">                class1 = class1.getSuperclass();</span>
<span class="nc bnc" id="L213" title="All 2 branches missed.">            } while (!class1.isAssignableFrom(class2));</span>
<span class="nc" id="L214">            return class1.getName().replace('.', '/');</span>
        }
    }

    private static class EnhancedStatusException extends RuntimeException {
        
        private static final long serialVersionUID = 1L;
        private final boolean status;

<span class="nc" id="L223">        private EnhancedStatusException(final boolean status) {</span>
<span class="nc" id="L224">            this.status = status;</span>
<span class="nc" id="L225">        }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.4.201905082037</span></div></body></html>