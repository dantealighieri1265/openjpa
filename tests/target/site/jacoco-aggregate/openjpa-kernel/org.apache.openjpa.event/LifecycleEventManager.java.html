<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="it"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>LifecycleEventManager.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Tests</a> &gt; <a href="../index.html" class="el_bundle">openjpa-kernel</a> &gt; <a href="index.source.html" class="el_package">org.apache.openjpa.event</a> &gt; <span class="el_source">LifecycleEventManager.java</span></div><h1>LifecycleEventManager.java</h1><pre class="source lang-java linenums">/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * &quot;License&quot;); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */
package org.apache.openjpa.event;

import java.io.Serializable;
import java.util.ArrayList;
import java.util.Collection;
import java.util.HashMap;
import java.util.Iterator;
import java.util.LinkedList;
import java.util.List;
import java.util.Map;

import org.apache.openjpa.lib.util.Localizer;
import org.apache.openjpa.meta.ClassMetaData;
import org.apache.openjpa.meta.MetaDataDefaults;
import org.apache.openjpa.util.InvalidStateException;

/**
 * Manager that can be used to track and notify listeners on lifecycle events.
 *  This class is optimized for event firing rather than for adding and
 * removing listeners, which are O(n) operations. This class also does not
 * maintain perfect set semantics for listeners; it is possible to wind up
 * having the same listener invoked multiple times for a single event if it
 * is added to this manager multiple times with different classes, or with
 * a base class and its subclass.
 *
 * @author Steve Kim
 * @author Abe White
 * @since 0.3.3
 */
<span class="nc" id="L48">public class LifecycleEventManager</span>
    implements CallbackModes, Serializable {

    private static final long serialVersionUID = 1L;

<span class="nc" id="L53">    private static final Exception[] EMPTY_EXCEPTIONS = new Exception[0];</span>

<span class="nc" id="L55">    private static final Localizer _loc = Localizer.forPackage(</span>
        LifecycleEventManager.class);

<span class="nc" id="L58">    private Map&lt;Class&lt;?&gt;, ListenerList&gt; _classListeners = null;</span>
<span class="nc" id="L59">    private ListenerList _listeners = null;</span>
    // odd-element: Listener even-element: Class[]
<span class="nc" id="L61">    private List&lt;Object&gt; _addListeners = new LinkedList&lt;&gt;();</span>
<span class="nc" id="L62">    private List&lt;Object&gt; _remListeners = new LinkedList&lt;&gt;();</span>
<span class="nc" id="L63">    private List&lt;Exception&gt; _exceps = new LinkedList&lt;&gt;();</span>
<span class="nc" id="L64">    private boolean _firing = false;</span>
<span class="nc" id="L65">    private boolean _fail = false;</span>
<span class="nc" id="L66">    private boolean _failFast = false;</span>
<span class="nc" id="L67">    private boolean _activated = false;  // set to true once modified</span>

    /**
     * Whether this LifeCycleEventManager has had at least one listener or callback
     * registered.  Used for a quick test when firing events.
     * @return boolean
     */
    public boolean isActive(ClassMetaData meta) {
<span class="nc bnc" id="L75" title="All 2 branches missed.">        return _activated ||</span>
<span class="nc bnc" id="L76" title="All 2 branches missed.">            meta.getLifecycleMetaData().is_activated() ||</span>
<span class="nc bnc" id="L77" title="All 2 branches missed.">            meta.getRepository().is_systemListenersActivated();</span>
    }

    /**
     * Whether to fail after first exception when firing events to listeners.
     */
    public boolean isFailFast() {
<span class="nc" id="L84">        return _failFast;</span>
    }

    /**
     * Whether to fail after first exception when firing events to listeners.
     */
    public void setFailFast(boolean failFast) {
<span class="nc" id="L91">        _failFast = failFast;</span>
<span class="nc" id="L92">    }</span>

    /**
     * Register a lifecycle listener for the given classes. If the classes
     * array is null, register for all classes.
     */
    public synchronized void addListener(Object listener, Class&lt;?&gt;[] classes) {
<span class="nc bnc" id="L99" title="All 2 branches missed.">        if (listener == null)</span>
<span class="nc" id="L100">            return;</span>
<span class="nc bnc" id="L101" title="All 4 branches missed.">        if (classes != null &amp;&amp; classes.length == 0)</span>
<span class="nc" id="L102">            return;</span>
<span class="nc" id="L103">        _activated = true;</span>
<span class="nc bnc" id="L104" title="All 2 branches missed.">        if (_firing) {</span>
<span class="nc" id="L105">            _addListeners.add(listener);</span>
<span class="nc" id="L106">            _addListeners.add(classes);</span>
<span class="nc" id="L107">            return;</span>
        }

<span class="nc bnc" id="L110" title="All 2 branches missed.">        if (classes == null) {</span>
<span class="nc bnc" id="L111" title="All 2 branches missed.">            if (_listeners == null)</span>
<span class="nc" id="L112">                _listeners = new ListenerList(5);</span>
<span class="nc" id="L113">            _listeners.add(listener);</span>
<span class="nc" id="L114">            return;</span>
        }

<span class="nc bnc" id="L117" title="All 2 branches missed.">        if (_classListeners == null)</span>
<span class="nc" id="L118">            _classListeners = new HashMap&lt;&gt;();</span>
        ListenerList listeners;
<span class="nc bnc" id="L120" title="All 2 branches missed.">        for (int i = 0; i &lt; classes.length; i++) {</span>
<span class="nc" id="L121">            listeners = _classListeners.get(classes[i]);</span>
<span class="nc bnc" id="L122" title="All 2 branches missed.">            if (listeners == null) {</span>
<span class="nc" id="L123">                listeners = new ListenerList(3);</span>
<span class="nc" id="L124">                _classListeners.put(classes[i], listeners);</span>
            }
<span class="nc" id="L126">            listeners.add(listener);</span>
        }
<span class="nc" id="L128">    }</span>

    /**
     * Remove the given listener.
     */
    public synchronized void removeListener(Object listener) {
<span class="nc bnc" id="L134" title="All 2 branches missed.">        if (_firing) {</span>
<span class="nc" id="L135">            _remListeners.add(listener);</span>
<span class="nc" id="L136">            return;</span>
        }

<span class="nc bnc" id="L139" title="All 4 branches missed.">        if (_listeners != null &amp;&amp; _listeners.remove(listener))</span>
<span class="nc" id="L140">            return;</span>
<span class="nc bnc" id="L141" title="All 2 branches missed.">        if (_classListeners != null) {</span>
            ListenerList listeners;
<span class="nc" id="L143">            for (Iterator&lt;ListenerList&gt; itr = _classListeners.values().iterator();</span>
<span class="nc bnc" id="L144" title="All 2 branches missed.">                itr.hasNext();) {</span>
<span class="nc" id="L145">                listeners = itr.next();</span>
<span class="nc" id="L146">                listeners.remove(listener);</span>
            }
        }
<span class="nc" id="L149">    }</span>

    /**
     * Return whether there are listeners or callbacks for the given source.
     */
    public boolean hasPersistListeners(Object source, ClassMetaData meta) {
<span class="nc bnc" id="L155" title="All 2 branches missed.">        return hasHandlers(source, meta, LifecycleEvent.BEFORE_PERSIST)</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">            || hasHandlers(source, meta, LifecycleEvent.AFTER_PERSIST)</span>
<span class="nc bnc" id="L157" title="All 2 branches missed.">            || hasHandlers(source, meta,</span>
                LifecycleEvent.AFTER_PERSIST_PERFORMED);
    }

    /**
     * Return whether there are listeners or callbacks for the given source.
     */
    public boolean hasDeleteListeners(Object source, ClassMetaData meta) {
<span class="nc bnc" id="L165" title="All 2 branches missed.">        return hasHandlers(source, meta, LifecycleEvent.BEFORE_DELETE)</span>
<span class="nc bnc" id="L166" title="All 2 branches missed.">            || hasHandlers(source, meta, LifecycleEvent.AFTER_DELETE)</span>
<span class="nc bnc" id="L167" title="All 2 branches missed.">            || hasHandlers(source, meta, LifecycleEvent.AFTER_DELETE_PERFORMED);</span>
    }

    /**
     * Return whether there are listeners or callbacks for the given source.
     */
    public boolean hasClearListeners(Object source, ClassMetaData meta) {
<span class="nc bnc" id="L174" title="All 2 branches missed.">        return hasHandlers(source, meta, LifecycleEvent.BEFORE_CLEAR)</span>
<span class="nc bnc" id="L175" title="All 2 branches missed.">            || hasHandlers(source, meta, LifecycleEvent.AFTER_CLEAR);</span>
    }

    /**
     * Return whether there are listeners or callbacks for the given source.
     */
    public boolean hasLoadListeners(Object source, ClassMetaData meta) {
<span class="nc" id="L182">        return hasHandlers(source, meta, LifecycleEvent.AFTER_LOAD);</span>
    }

    /**
     * Return whether there are listeners or callbacks for the given source.
     */
    public boolean hasStoreListeners(Object source, ClassMetaData meta) {
<span class="nc bnc" id="L189" title="All 2 branches missed.">        return hasHandlers(source, meta, LifecycleEvent.BEFORE_STORE)</span>
<span class="nc bnc" id="L190" title="All 2 branches missed.">            || hasHandlers(source, meta, LifecycleEvent.AFTER_STORE);</span>
    }

    /**
     * Return whether there are listeners or callbacks for the given source.
     */
    public boolean hasUpdateListeners(Object source, ClassMetaData meta) {
<span class="nc bnc" id="L197" title="All 2 branches missed.">        return hasHandlers(source, meta, LifecycleEvent.BEFORE_UPDATE)</span>
<span class="nc bnc" id="L198" title="All 2 branches missed.">            || hasHandlers(source, meta, LifecycleEvent.AFTER_UPDATE_PERFORMED);</span>
    }

    /**
     * Return whether there are listeners or callbacks for the given source.
     */
    public boolean hasDirtyListeners(Object source, ClassMetaData meta) {
<span class="nc bnc" id="L205" title="All 2 branches missed.">        return hasHandlers(source, meta, LifecycleEvent.BEFORE_DIRTY)</span>
<span class="nc bnc" id="L206" title="All 2 branches missed.">            || hasHandlers(source, meta, LifecycleEvent.AFTER_DIRTY);</span>
    }

    /**
     * Return whether there are listeners or callbacks for the given source.
     */
    public boolean hasDetachListeners(Object source, ClassMetaData meta) {
<span class="nc bnc" id="L213" title="All 2 branches missed.">        return hasHandlers(source, meta, LifecycleEvent.BEFORE_DETACH)</span>
<span class="nc bnc" id="L214" title="All 2 branches missed.">            || hasHandlers(source, meta, LifecycleEvent.AFTER_DETACH);</span>
    }

    /**
     * Return whether there are listeners or callbacks for the given source.
     */
    public boolean hasAttachListeners(Object source, ClassMetaData meta) {
<span class="nc bnc" id="L221" title="All 2 branches missed.">        return hasHandlers(source, meta, LifecycleEvent.BEFORE_ATTACH)</span>
<span class="nc bnc" id="L222" title="All 2 branches missed.">            || hasHandlers(source, meta, LifecycleEvent.AFTER_ATTACH);</span>
    }

    private boolean hasHandlers(Object source, ClassMetaData meta, int type) {
<span class="nc bnc" id="L226" title="All 2 branches missed.">        return hasCallbacks(source, meta, type)</span>
<span class="nc bnc" id="L227" title="All 2 branches missed.">            || hasListeners(source, meta, type);</span>
    }

    /**
     * Return true if any callbacks are registered for the given source and
     * event type.
     */
    private boolean hasCallbacks(Object source, ClassMetaData meta, int type) {
<span class="nc" id="L235">        LifecycleCallbacks[] callbacks = meta.getLifecycleMetaData().</span>
<span class="nc" id="L236">            getCallbacks(type);</span>
<span class="nc bnc" id="L237" title="All 2 branches missed.">        if (callbacks.length == 0)</span>
<span class="nc" id="L238">            return false;</span>
<span class="nc bnc" id="L239" title="All 2 branches missed.">        for (int i = 0; i &lt; callbacks.length; i++)</span>
<span class="nc bnc" id="L240" title="All 2 branches missed.">            if (callbacks[i].hasCallback(source, type))</span>
<span class="nc" id="L241">                return true;</span>
<span class="nc" id="L242">        return false;</span>
    }

    /**
     * Return true if any listeners are registered for the given source and
     * event type.
     */
    private boolean hasListeners(Object source,
        ClassMetaData meta, int type) {
<span class="nc bnc" id="L251" title="All 2 branches missed.">        if (meta.getLifecycleMetaData().getIgnoreSystemListeners())</span>
<span class="nc" id="L252">            return false;</span>
<span class="nc bnc" id="L253" title="All 2 branches missed.">        if (fireEvent(null, source, null, type, _listeners, true, null) == Boolean.TRUE)</span>
<span class="nc" id="L254">            return true;</span>
<span class="nc" id="L255">        ListenerList system = meta.getRepository().getSystemListeners();</span>
<span class="nc bnc" id="L256" title="All 4 branches missed.">        if (!system.isEmpty() &amp;&amp; fireEvent(null, source, null, type, system,</span>
            true, null) == Boolean.TRUE)
<span class="nc" id="L258">            return true;</span>
<span class="nc bnc" id="L259" title="All 2 branches missed.">        if (_classListeners != null) {</span>
<span class="nc bnc" id="L260" title="All 2 branches missed.">            Class&lt;?&gt; c = source == null ? meta.getDescribedType() : source.getClass();</span>
            do {
<span class="nc bnc" id="L262" title="All 2 branches missed.">                if (fireEvent(null, source, null, type, _classListeners.get(c), true, null) == Boolean.TRUE)</span>
<span class="nc" id="L263">                    return true;</span>
<span class="nc" id="L264">                c = c.getSuperclass();</span>
<span class="nc bnc" id="L265" title="All 4 branches missed.">            } while (c != null &amp;&amp; c != Object.class);</span>
        }
<span class="nc" id="L267">        return false;</span>
    }

    /**
     * Fire lifecycle event to all registered listeners without an argument.
     */
    public Exception[] fireEvent(Object source,
        ClassMetaData meta, int type) {
<span class="nc" id="L275">        return fireEvent(source, null, meta, type);</span>
    }

    /**
     * Fire lifecycle event to all registered listeners.
     */
    public synchronized Exception[] fireEvent(Object source, Object related,
        ClassMetaData meta, int type) {
<span class="nc" id="L283">        boolean reentrant = _firing;</span>
<span class="nc" id="L284">        _firing = true;</span>
<span class="nc bnc" id="L285" title="All 2 branches missed.">        List&lt;Exception&gt; exceptions = (reentrant) ? new LinkedList&lt;&gt;() : _exceps;</span>
<span class="nc" id="L286">        MetaDataDefaults def = meta.getRepository().getMetaDataFactory().</span>
<span class="nc" id="L287">            getDefaults();</span>

<span class="nc" id="L289">        boolean callbacks = def.getCallbacksBeforeListeners(type);</span>
<span class="nc bnc" id="L290" title="All 2 branches missed.">        if (callbacks)</span>
<span class="nc" id="L291">            makeCallbacks(source, related, meta, type, exceptions);</span>

<span class="nc" id="L293">        LifecycleEvent ev = (LifecycleEvent) fireEvent(null, source, related,</span>
            type, _listeners, false, exceptions);

<span class="nc bnc" id="L296" title="All 2 branches missed.">        if (_classListeners != null) {</span>
<span class="nc bnc" id="L297" title="All 2 branches missed.">            Class&lt;?&gt; c = source == null ? meta.getDescribedType() : source.getClass();</span>
            do {
<span class="nc" id="L299">                ev = (LifecycleEvent) fireEvent(ev, source, related, type,</span>
<span class="nc" id="L300">                    _classListeners.get(c), false, exceptions);</span>
<span class="nc" id="L301">                c = c.getSuperclass();</span>
<span class="nc bnc" id="L302" title="All 4 branches missed.">            } while (c != null &amp;&amp; c != Object.class);</span>
        }

        // make system listeners
<span class="nc bnc" id="L306" title="All 2 branches missed.">        if (!meta.getLifecycleMetaData().getIgnoreSystemListeners()) {</span>
<span class="nc" id="L307">            ListenerList system = meta.getRepository().getSystemListeners();</span>
<span class="nc" id="L308">            fireEvent(ev, source, related, type, system, false, exceptions);</span>
        }

<span class="nc bnc" id="L311" title="All 2 branches missed.">        if (!callbacks)</span>
<span class="nc" id="L312">            makeCallbacks(source, related, meta, type, exceptions);</span>

        // create return array before clearing exceptions
        Exception[] ret;
<span class="nc bnc" id="L316" title="All 2 branches missed.">        if (exceptions.isEmpty())</span>
<span class="nc" id="L317">            ret = EMPTY_EXCEPTIONS;</span>
        else
<span class="nc" id="L319">            ret = exceptions.toArray</span>
<span class="nc" id="L320">                (new Exception[exceptions.size()]);</span>

        // if this wasn't a reentrant call, catch up with calls to add
        // and remove listeners made while firing
<span class="nc bnc" id="L324" title="All 2 branches missed.">        if (!reentrant) {</span>
<span class="nc" id="L325">            _firing = false;</span>
<span class="nc" id="L326">            _fail = false;</span>
<span class="nc bnc" id="L327" title="All 2 branches missed.">            if (!_addListeners.isEmpty())</span>
<span class="nc bnc" id="L328" title="All 2 branches missed.">                for (Iterator&lt;Object&gt; itr = _addListeners.iterator(); itr.hasNext();)</span>
<span class="nc" id="L329">                    addListener(itr.next(), (Class[]) itr.next());</span>
<span class="nc bnc" id="L330" title="All 2 branches missed.">            if (!_remListeners.isEmpty())</span>
<span class="nc bnc" id="L331" title="All 2 branches missed.">                for (Iterator&lt;Object&gt; itr = _remListeners.iterator(); itr.hasNext();)</span>
<span class="nc" id="L332">                    removeListener(itr.next());</span>
<span class="nc" id="L333">            _addListeners.clear();</span>
<span class="nc" id="L334">            _remListeners.clear();</span>
<span class="nc" id="L335">            _exceps.clear();</span>
        }
<span class="nc" id="L337">        return ret;</span>
    }

    /**
     * Make callbacks, recording any exceptions in the given collection.
     */
    private void makeCallbacks(Object source, Object related,
        ClassMetaData meta, int type, Collection&lt;Exception&gt; exceptions) {
        // make lifecycle callbacks
<span class="nc" id="L346">        LifecycleCallbacks[] callbacks = meta.getLifecycleMetaData().</span>
<span class="nc" id="L347">            getCallbacks(type);</span>
<span class="nc bnc" id="L348" title="All 4 branches missed.">        for (int i = 0; !_fail &amp;&amp; i &lt; callbacks.length; i++) {</span>
            try {
<span class="nc" id="L350">                callbacks[i].makeCallback(source, related, type);</span>
<span class="nc" id="L351">            } catch (Exception e) {</span>
<span class="nc" id="L352">                exceptions.add(e);</span>
<span class="nc bnc" id="L353" title="All 2 branches missed.">                if (_failFast)</span>
<span class="nc" id="L354">                    _fail = true;</span>
<span class="nc" id="L355">            }</span>
        }
<span class="nc" id="L357">    }</span>

    /**
     * Fire an event with the given source and type to the given list of
     * listeners. The event may have already been constructed.
     */
    private Object fireEvent(LifecycleEvent ev, Object source, Object rel,
        int type, ListenerList listeners, boolean mock, List&lt;Exception&gt; exceptions) {
<span class="nc bnc" id="L365" title="All 4 branches missed.">        if (listeners == null || !listeners.hasListeners(type))</span>
<span class="nc" id="L366">            return null;</span>

        Object listener;
        boolean responds;
<span class="nc bnc" id="L370" title="All 4 branches missed.">        for (int i = 0, size = listeners.size(); !_fail &amp;&amp; i &lt; size; i++) {</span>
<span class="nc" id="L371">            listener = listeners.get(i);</span>
<span class="nc bnc" id="L372" title="All 2 branches missed.">            if (size == 1)</span>
<span class="nc" id="L373">                responds = true;</span>
<span class="nc bnc" id="L374" title="All 2 branches missed.">            else if (listener instanceof ListenerAdapter) {</span>
<span class="nc" id="L375">                responds = ((ListenerAdapter) listener).respondsTo(type);</span>
<span class="nc bnc" id="L376" title="All 2 branches missed.">                if (!responds)</span>
<span class="nc" id="L377">                    continue;</span>
            } else {
<span class="nc" id="L379">                responds = false;</span>
            }
            try {
<span class="nc bnc" id="L382" title="All 12 branches missed.">                switch (type) {</span>
                    case LifecycleEvent.BEFORE_CLEAR:
                    case LifecycleEvent.AFTER_CLEAR:
<span class="nc bnc" id="L385" title="All 4 branches missed.">                        if (responds || listener instanceof ClearListener) {</span>
<span class="nc bnc" id="L386" title="All 2 branches missed.">                            if (mock)</span>
<span class="nc" id="L387">                                return Boolean.TRUE;</span>
<span class="nc bnc" id="L388" title="All 2 branches missed.">                            if (ev == null)</span>
<span class="nc" id="L389">                                ev = new LifecycleEvent(source, type);</span>
<span class="nc bnc" id="L390" title="All 2 branches missed.">                            if (type == LifecycleEvent.BEFORE_CLEAR)</span>
<span class="nc" id="L391">                                ((ClearListener) listener).beforeClear(ev);</span>
                            else
<span class="nc" id="L393">                                ((ClearListener) listener).afterClear(ev);</span>
                        }
                        break;
                    case LifecycleEvent.BEFORE_PERSIST:
                    case LifecycleEvent.AFTER_PERSIST:
<span class="nc bnc" id="L398" title="All 4 branches missed.">                        if (responds || listener instanceof PersistListener) {</span>
<span class="nc bnc" id="L399" title="All 2 branches missed.">                            if (mock)</span>
<span class="nc" id="L400">                                return Boolean.TRUE;</span>
<span class="nc bnc" id="L401" title="All 2 branches missed.">                            if (ev == null)</span>
<span class="nc" id="L402">                                ev = new LifecycleEvent(source, type);</span>
<span class="nc bnc" id="L403" title="All 2 branches missed.">                            if (type == LifecycleEvent.BEFORE_PERSIST)</span>
<span class="nc" id="L404">                                ((PersistListener) listener).beforePersist(ev);</span>
                            else
<span class="nc" id="L406">                                ((PersistListener) listener).afterPersist(ev);</span>
                        }
                        break;
                    case LifecycleEvent.BEFORE_DELETE:
                    case LifecycleEvent.AFTER_DELETE:
<span class="nc bnc" id="L411" title="All 4 branches missed.">                        if (responds || listener instanceof DeleteListener) {</span>
<span class="nc bnc" id="L412" title="All 2 branches missed.">                            if (mock)</span>
<span class="nc" id="L413">                                return Boolean.TRUE;</span>
<span class="nc bnc" id="L414" title="All 2 branches missed.">                            if (ev == null)</span>
<span class="nc" id="L415">                                ev = new LifecycleEvent(source, type);</span>
<span class="nc bnc" id="L416" title="All 2 branches missed.">                            if (type == LifecycleEvent.BEFORE_DELETE)</span>
<span class="nc" id="L417">                                ((DeleteListener) listener).beforeDelete(ev);</span>
                            else
<span class="nc" id="L419">                                ((DeleteListener) listener).afterDelete(ev);</span>
                        }
                        break;
                    case LifecycleEvent.BEFORE_DIRTY:
                    case LifecycleEvent.AFTER_DIRTY:
                    case LifecycleEvent.BEFORE_DIRTY_FLUSHED:
                    case LifecycleEvent.AFTER_DIRTY_FLUSHED:
<span class="nc bnc" id="L426" title="All 4 branches missed.">                        if (responds || listener instanceof DirtyListener) {</span>
<span class="nc bnc" id="L427" title="All 2 branches missed.">                            if (mock)</span>
<span class="nc" id="L428">                                return Boolean.TRUE;</span>
<span class="nc bnc" id="L429" title="All 2 branches missed.">                            if (ev == null)</span>
<span class="nc" id="L430">                                ev = new LifecycleEvent(source, type);</span>
<span class="nc bnc" id="L431" title="All 5 branches missed.">                            switch (type) {</span>
                                case LifecycleEvent.BEFORE_DIRTY:
<span class="nc" id="L433">                                    ((DirtyListener) listener).beforeDirty(ev);</span>
<span class="nc" id="L434">                                    break;</span>
                                case LifecycleEvent.AFTER_DIRTY:
<span class="nc" id="L436">                                    ((DirtyListener) listener).afterDirty(ev);</span>
<span class="nc" id="L437">                                    break;</span>
                                case LifecycleEvent.BEFORE_DIRTY_FLUSHED:
<span class="nc" id="L439">                                    ((DirtyListener) listener)</span>
<span class="nc" id="L440">                                        .beforeDirtyFlushed(ev);</span>
<span class="nc" id="L441">                                    break;</span>
                                case LifecycleEvent.AFTER_DIRTY_FLUSHED:
<span class="nc" id="L443">                                    ((DirtyListener) listener)</span>
<span class="nc" id="L444">                                        .afterDirtyFlushed(ev);</span>
<span class="nc" id="L445">                                    break;</span>
                            }
                        }
                        break;
                    case LifecycleEvent.AFTER_LOAD:
                    case LifecycleEvent.AFTER_REFRESH:
<span class="nc bnc" id="L451" title="All 4 branches missed.">                        if (responds || listener instanceof LoadListener) {</span>
<span class="nc bnc" id="L452" title="All 2 branches missed.">                            if (mock)</span>
<span class="nc" id="L453">                                return Boolean.TRUE;</span>
<span class="nc bnc" id="L454" title="All 2 branches missed.">                            if (ev == null)</span>
<span class="nc" id="L455">                                ev = new LifecycleEvent(source, type);</span>
<span class="nc bnc" id="L456" title="All 2 branches missed.">                            if (type == LifecycleEvent.AFTER_LOAD)</span>
<span class="nc" id="L457">                                ((LoadListener) listener).afterLoad(ev);</span>
                            else
<span class="nc" id="L459">                                ((LoadListener) listener).afterRefresh(ev);</span>
                        }
                        break;
                    case LifecycleEvent.BEFORE_STORE:
                    case LifecycleEvent.AFTER_STORE:
<span class="nc bnc" id="L464" title="All 4 branches missed.">                        if (responds || listener instanceof StoreListener) {</span>
<span class="nc bnc" id="L465" title="All 2 branches missed.">                            if (mock)</span>
<span class="nc" id="L466">                                return Boolean.TRUE;</span>
<span class="nc bnc" id="L467" title="All 2 branches missed.">                            if (ev == null)</span>
<span class="nc" id="L468">                                ev = new LifecycleEvent(source, type);</span>
<span class="nc bnc" id="L469" title="All 2 branches missed.">                            if (type == LifecycleEvent.BEFORE_STORE)</span>
<span class="nc" id="L470">                                ((StoreListener) listener).beforeStore(ev);</span>
                            else
<span class="nc" id="L472">                                ((StoreListener) listener).afterStore(ev);</span>
                        }
                        break;
                    case LifecycleEvent.BEFORE_DETACH:
                    case LifecycleEvent.AFTER_DETACH:
<span class="nc bnc" id="L477" title="All 4 branches missed.">                        if (responds || listener instanceof DetachListener) {</span>
<span class="nc bnc" id="L478" title="All 2 branches missed.">                            if (mock)</span>
<span class="nc" id="L479">                                return Boolean.TRUE;</span>
<span class="nc bnc" id="L480" title="All 2 branches missed.">                            if (ev == null)</span>
<span class="nc" id="L481">                                ev = new LifecycleEvent(source, rel, type);</span>
<span class="nc bnc" id="L482" title="All 2 branches missed.">                            if (type == LifecycleEvent.BEFORE_DETACH)</span>
<span class="nc" id="L483">                                ((DetachListener) listener).beforeDetach(ev);</span>
                            else
<span class="nc" id="L485">                                ((DetachListener) listener).afterDetach(ev);</span>
                        }
                        break;
                    case LifecycleEvent.BEFORE_ATTACH:
                    case LifecycleEvent.AFTER_ATTACH:
<span class="nc bnc" id="L490" title="All 4 branches missed.">                        if (responds || listener instanceof AttachListener) {</span>
<span class="nc bnc" id="L491" title="All 2 branches missed.">                            if (mock)</span>
<span class="nc" id="L492">                                return Boolean.TRUE;</span>
<span class="nc bnc" id="L493" title="All 2 branches missed.">                            if (ev == null)</span>
<span class="nc" id="L494">                                ev = new LifecycleEvent(source, rel, type);</span>
<span class="nc bnc" id="L495" title="All 2 branches missed.">                            if (type == LifecycleEvent.BEFORE_ATTACH)</span>
<span class="nc" id="L496">                                ((AttachListener) listener).beforeAttach(ev);</span>
                            else
<span class="nc" id="L498">                                ((AttachListener) listener).afterAttach(ev);</span>
                        }
                        break;

                    case LifecycleEvent.AFTER_PERSIST_PERFORMED:
<span class="nc bnc" id="L503" title="All 4 branches missed.">                        if (responds || listener instanceof PostPersistListener) {</span>
<span class="nc bnc" id="L504" title="All 2 branches missed.">                            if (mock)</span>
<span class="nc" id="L505">                                return Boolean.TRUE;</span>
<span class="nc bnc" id="L506" title="All 2 branches missed.">                            if (ev == null)</span>
<span class="nc" id="L507">                                ev = new LifecycleEvent(source, rel, type);</span>
<span class="nc" id="L508">                            ((PostPersistListener) listener).afterPersistPerformed(ev);</span>
                        }
                        break;
                    case LifecycleEvent.BEFORE_UPDATE:
                    case LifecycleEvent.AFTER_UPDATE_PERFORMED:
<span class="nc bnc" id="L513" title="All 4 branches missed.">                        if (responds || listener instanceof UpdateListener) {</span>
<span class="nc bnc" id="L514" title="All 2 branches missed.">                            if (mock)</span>
<span class="nc" id="L515">                                return Boolean.TRUE;</span>
<span class="nc bnc" id="L516" title="All 2 branches missed.">                            if (ev == null)</span>
<span class="nc" id="L517">                                ev = new LifecycleEvent(source, rel, type);</span>
<span class="nc bnc" id="L518" title="All 2 branches missed.">                            if (type == LifecycleEvent.BEFORE_UPDATE)</span>
<span class="nc" id="L519">                                ((UpdateListener) listener).beforeUpdate(ev);</span>
                            else
<span class="nc" id="L521">                                ((UpdateListener) listener).afterUpdatePerformed(ev);</span>
                        }
                        break;
                    case LifecycleEvent.AFTER_DELETE_PERFORMED:
<span class="nc bnc" id="L525" title="All 4 branches missed.">                        if (responds || listener instanceof PostDeleteListener){</span>
<span class="nc bnc" id="L526" title="All 2 branches missed.">                            if (mock)</span>
<span class="nc" id="L527">                                return Boolean.TRUE;</span>
<span class="nc bnc" id="L528" title="All 2 branches missed.">                            if (ev == null)</span>
<span class="nc" id="L529">                                ev = new LifecycleEvent(source, rel, type);</span>
<span class="nc" id="L530">                            ((PostDeleteListener) listener).afterDeletePerformed(ev);</span>
                        }
                        break;
                    default:
<span class="nc" id="L534">                        throw new InvalidStateException(_loc.get(&quot;unknown-lifecycle-event&quot;, Integer.toString(type)));</span>
                }
            }
<span class="nc" id="L537">            catch (Exception e) {</span>
<span class="nc" id="L538">                exceptions.add(e);</span>
<span class="nc bnc" id="L539" title="All 2 branches missed.">                if (_failFast)</span>
<span class="nc" id="L540">                    _fail = true;</span>
<span class="nc" id="L541">            }</span>
        }
<span class="nc" id="L543">        return ev;</span>
    }

    /**
     * Interface that facades to other lifecycle listener interfaces can
     * implement to choose which events to respond to based on their delegate.
     * This is more efficient than registering as a listener for all events
     * but only responding to some.
     */
    public interface ListenerAdapter {

        /**
         * Return whether this instance responds to the given event type from
         * {@link LifecycleEvent}.
         */
        boolean respondsTo(int eventType);
    }

    /**
     * Extended list that tracks what event types its elements care about.
     * Maintains set semantics as well.
     */
    public static class ListenerList extends ArrayList&lt;Object&gt; {

        
        private static final long serialVersionUID = 1L;
<span class="nc" id="L569">        private int _types = 0;</span>

        public ListenerList(int size) {
<span class="nc" id="L572">            super(size);</span>
<span class="nc" id="L573">        }</span>

        public ListenerList(ListenerList copy) {
<span class="nc" id="L576">            super(copy);</span>
<span class="nc" id="L577">            _types = copy._types;</span>
<span class="nc" id="L578">        }</span>

        public boolean hasListeners(int type) {
<span class="nc bnc" id="L581" title="All 2 branches missed.">            return (_types &amp; (2 &lt;&lt; type)) &gt; 0;</span>
        }

        @Override
        public boolean add(Object listener) {
<span class="nc bnc" id="L586" title="All 2 branches missed.">            if (contains(listener))</span>
<span class="nc" id="L587">                return false;</span>
<span class="nc" id="L588">            super.add(listener);</span>
<span class="nc" id="L589">            _types |= getEventTypes(listener);</span>
<span class="nc" id="L590">            return true;</span>
        }

        @Override
        public boolean remove(Object listener) {
<span class="nc bnc" id="L595" title="All 2 branches missed.">            if (!super.remove(listener))</span>
<span class="nc" id="L596">                return false;</span>

            // recompute types mask
<span class="nc" id="L599">            _types = 0;</span>
<span class="nc bnc" id="L600" title="All 2 branches missed.">            for (int i = 0; i &lt; size(); i++)</span>
<span class="nc" id="L601">                _types |= getEventTypes(get(i));</span>
<span class="nc" id="L602">            return true;</span>
        }

        /**
         * Return a mask of the event types the given listener processes.
         */
        private static int getEventTypes(Object listener) {
<span class="nc" id="L609">            int types = 0;</span>
<span class="nc bnc" id="L610" title="All 2 branches missed.">            if (listener instanceof ListenerAdapter) {</span>
<span class="nc" id="L611">                ListenerAdapter adapter = (ListenerAdapter) listener;</span>
<span class="nc bnc" id="L612" title="All 2 branches missed.">                for (int i = 0; i &lt; LifecycleEvent.ALL_EVENTS.length; i++)</span>
<span class="nc bnc" id="L613" title="All 2 branches missed.">                    if (adapter.respondsTo(LifecycleEvent.ALL_EVENTS[i]))</span>
<span class="nc" id="L614">                        types |= 2 &lt;&lt; LifecycleEvent.ALL_EVENTS[i];</span>
<span class="nc" id="L615">                return types;</span>
            }

<span class="nc bnc" id="L618" title="All 2 branches missed.">            if (listener instanceof PersistListener) {</span>
<span class="nc" id="L619">                types |= 2 &lt;&lt; LifecycleEvent.BEFORE_PERSIST;</span>
<span class="nc" id="L620">                types |= 2 &lt;&lt; LifecycleEvent.AFTER_PERSIST;</span>
            }
<span class="nc bnc" id="L622" title="All 2 branches missed.">            if (listener instanceof ClearListener) {</span>
<span class="nc" id="L623">                types |= 2 &lt;&lt; LifecycleEvent.BEFORE_CLEAR;</span>
<span class="nc" id="L624">                types |= 2 &lt;&lt; LifecycleEvent.AFTER_CLEAR;</span>
            }
<span class="nc bnc" id="L626" title="All 2 branches missed.">            if (listener instanceof DeleteListener) {</span>
<span class="nc" id="L627">                types |= 2 &lt;&lt; LifecycleEvent.BEFORE_DELETE;</span>
<span class="nc" id="L628">                types |= 2 &lt;&lt; LifecycleEvent.AFTER_DELETE;</span>
            }
<span class="nc bnc" id="L630" title="All 2 branches missed.">            if (listener instanceof DirtyListener) {</span>
<span class="nc" id="L631">                types |= 2 &lt;&lt; LifecycleEvent.BEFORE_DIRTY;</span>
<span class="nc" id="L632">                types |= 2 &lt;&lt; LifecycleEvent.AFTER_DIRTY;</span>
<span class="nc" id="L633">                types |= 2 &lt;&lt; LifecycleEvent.BEFORE_DIRTY_FLUSHED;</span>
<span class="nc" id="L634">                types |= 2 &lt;&lt; LifecycleEvent.AFTER_DIRTY_FLUSHED;</span>
            }
<span class="nc bnc" id="L636" title="All 2 branches missed.">            if (listener instanceof LoadListener) {</span>
<span class="nc" id="L637">                types |= 2 &lt;&lt; LifecycleEvent.AFTER_LOAD;</span>
<span class="nc" id="L638">                types |= 2 &lt;&lt; LifecycleEvent.AFTER_REFRESH;</span>
            }
<span class="nc bnc" id="L640" title="All 2 branches missed.">            if (listener instanceof StoreListener) {</span>
<span class="nc" id="L641">                types |= 2 &lt;&lt; LifecycleEvent.BEFORE_STORE;</span>
<span class="nc" id="L642">                types |= 2 &lt;&lt; LifecycleEvent.AFTER_STORE;</span>
            }
<span class="nc bnc" id="L644" title="All 2 branches missed.">            if (listener instanceof DetachListener) {</span>
<span class="nc" id="L645">                types |= 2 &lt;&lt; LifecycleEvent.BEFORE_DETACH;</span>
<span class="nc" id="L646">                types |= 2 &lt;&lt; LifecycleEvent.AFTER_DETACH;</span>
            }
<span class="nc bnc" id="L648" title="All 2 branches missed.">            if (listener instanceof AttachListener) {</span>
<span class="nc" id="L649">                types |= 2 &lt;&lt; LifecycleEvent.BEFORE_ATTACH;</span>
<span class="nc" id="L650">                types |= 2 &lt;&lt; LifecycleEvent.AFTER_ATTACH;</span>
			}
<span class="nc" id="L652">			return types;</span>
		}
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.4.201905082037</span></div></body></html>