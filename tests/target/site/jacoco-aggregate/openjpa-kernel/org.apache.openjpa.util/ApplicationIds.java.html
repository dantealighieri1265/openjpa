<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="it"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>ApplicationIds.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Tests</a> &gt; <a href="../index.html" class="el_bundle">openjpa-kernel</a> &gt; <a href="index.source.html" class="el_package">org.apache.openjpa.util</a> &gt; <span class="el_source">ApplicationIds.java</span></div><h1>ApplicationIds.java</h1><pre class="source lang-java linenums">/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * &quot;License&quot;); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */
package org.apache.openjpa.util;

import java.lang.reflect.Field;
import java.lang.reflect.Modifier;
import java.math.BigDecimal;
import java.math.BigInteger;
import java.security.AccessController;
import java.security.PrivilegedActionException;
import java.util.Date;

import org.apache.openjpa.enhance.FieldManager;
import org.apache.openjpa.enhance.PCRegistry;
import org.apache.openjpa.enhance.PersistenceCapable;
import org.apache.openjpa.enhance.Reflection;
import org.apache.openjpa.kernel.ObjectIdStateManager;
import org.apache.openjpa.kernel.OpenJPAStateManager;
import org.apache.openjpa.kernel.StateManagerImpl;
import org.apache.openjpa.kernel.StoreManager;
import org.apache.openjpa.lib.util.J2DoPrivHelper;
import org.apache.openjpa.lib.util.Localizer;
import org.apache.openjpa.meta.AccessCode;
import org.apache.openjpa.meta.ClassMetaData;
import org.apache.openjpa.meta.FieldMetaData;
import org.apache.openjpa.meta.JavaTypes;
import org.apache.openjpa.meta.ValueStrategies;

/**
 * Utility class for manipulating application object ids.
 *
 * @author Abe White
 */
<span class="nc" id="L50">public class ApplicationIds {</span>

<span class="nc" id="L52">    private static final Localizer _loc = Localizer.forPackage</span>
<span class="nc" id="L53">        (ApplicationIds.class);</span>
<span class="nc" id="L54">    private static final Localizer _loc2 = Localizer.forPackage</span>
<span class="nc" id="L55">        (StateManagerImpl.class);</span>

    /**
     * Return the primary key values for the given object id. The values
     * will be returned in the same order as the metadata primary key fields.
     * Values for PC primary key fields will be the primary key value or
     * oid value of the related instance (depending on
     * {@link FieldMetaData#isObjectIdFieldIdOfPC}).
     */
    public static Object[] toPKValues(Object oid, ClassMetaData meta) {
<span class="nc bnc" id="L65" title="All 2 branches missed.">        if (meta == null)</span>
<span class="nc" id="L66">            return null;</span>

        Object[] pks;
<span class="nc bnc" id="L69" title="All 2 branches missed.">        if (meta.isOpenJPAIdentity()) {</span>
<span class="nc" id="L70">            pks = new Object[1];</span>
<span class="nc bnc" id="L71" title="All 2 branches missed.">            if (oid != null)</span>
<span class="nc" id="L72">                pks[0] = ((OpenJPAId) oid).getIdObject();</span>
<span class="nc" id="L73">            return pks;</span>
        }

        // reset owning 'meta' to the owner of the primary key fields, because
        // the one passed in might be a proxy, like for embedded mappings;
        // since getPrimaryKeyFields is guaranteed to return the primary
        // keys in the order of inheritance, we are guaranteed that
        // the last element will be the most-derived class.
<span class="nc" id="L81">        FieldMetaData[] fmds = meta.getPrimaryKeyFields();</span>
<span class="nc" id="L82">        meta = fmds[fmds.length - 1].getDeclaringMetaData();</span>
<span class="nc" id="L83">        pks = new Object[fmds.length];</span>
<span class="nc bnc" id="L84" title="All 2 branches missed.">        if (oid == null)</span>
<span class="nc" id="L85">            return pks;</span>

<span class="nc bnc" id="L87" title="All 2 branches missed.">        if (!Modifier.isAbstract(meta.getDescribedType().getModifiers())) {</span>
            // copy fields from the oid
<span class="nc" id="L89">            PrimaryKeyFieldManager consumer = new PrimaryKeyFieldManager();</span>
<span class="nc" id="L90">            consumer.setStore(pks);</span>
<span class="nc" id="L91">            oid = wrap(meta, oid);</span>
<span class="nc" id="L92">            PCRegistry.copyKeyFieldsFromObjectId(meta.getDescribedType(),</span>
                consumer, oid);
<span class="nc" id="L94">            return consumer.getStore();</span>
        }

        // default to reflection
<span class="nc bnc" id="L98" title="All 2 branches missed.">        if (meta.isObjectIdTypeShared())</span>
<span class="nc" id="L99">            oid = ((ObjectId) oid).getId();</span>
<span class="nc" id="L100">        Class&lt;?&gt; oidType = oid.getClass();</span>
<span class="nc bnc" id="L101" title="All 2 branches missed.">        for (int i = 0; i &lt; fmds.length; i++) {</span>
<span class="nc bnc" id="L102" title="All 2 branches missed.">            if (AccessCode.isField(meta.getAccessType()))</span>
<span class="nc" id="L103">                pks[i] = Reflection.get(oid, Reflection.findField(oidType,</span>
<span class="nc" id="L104">                    fmds[i].getName(), true));</span>
            else
<span class="nc" id="L106">                pks[i] = Reflection.get(oid, Reflection.findGetter(oidType,</span>
<span class="nc" id="L107">                    fmds[i].getName(), true));</span>
        }
<span class="nc" id="L109">        return pks;</span>
    }

    /**
     * Wraps the given object for the given type into a OpenJPA specific
     * application identity object wrapper instance (i.e. ObjectId) if all of
     * the following is true:
     * the given type is not using built-in OpenJPA identity types
     * the given type is using a shared OpenJPA identity type
     * the given object is not already a wrapper identity type
     */
    public static Object wrap(ClassMetaData meta, Object oid) {
<span class="nc bnc" id="L121" title="All 2 branches missed.">        if (!meta.isOpenJPAIdentity()</span>
<span class="nc bnc" id="L122" title="All 4 branches missed.">         &amp;&amp; meta.isObjectIdTypeShared()</span>
         &amp;&amp; !(oid instanceof ObjectId)) {
<span class="nc" id="L124">        	return new ObjectId(meta.getDescribedType(), oid);</span>
        }
<span class="nc" id="L126">        return oid;</span>
    }


    /**
     * Return a new object id constructed from the given primary key values.
     * Values for PC primary key fields should be the primary key value or
     * oid value of the related instance (depending on
     * {@link FieldMetaData#isObjectIdFieldIdOfPC}).
     */
    public static Object fromPKValues(Object[] pks, ClassMetaData meta) {
<span class="nc bnc" id="L137" title="All 4 branches missed.">        if (meta == null || pks == null)</span>
<span class="nc" id="L138">            return null;</span>

<span class="nc" id="L140">        boolean convert = !meta.getRepository().getConfiguration().</span>
<span class="nc bnc" id="L141" title="All 2 branches missed.">            getCompatibilityInstance().getStrictIdentityValues();</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">        if (meta.isOpenJPAIdentity()) {</span>
<span class="nc" id="L143">            int type = meta.getPrimaryKeyFields()[0].getObjectIdFieldTypeCode();</span>
<span class="nc bnc" id="L144" title="All 2 branches missed.">            Object val = (convert) ? JavaTypes.convert(pks[0], type) : pks[0];</span>
<span class="nc bnc" id="L145" title="All 14 branches missed.">            switch (type) {</span>
                case JavaTypes.BYTE:
                case JavaTypes.BYTE_OBJ:
<span class="nc bnc" id="L148" title="All 4 branches missed.">                    if (!convert &amp;&amp; !(val instanceof Byte))</span>
<span class="nc" id="L149">                        throw new ClassCastException(&quot;!(x instanceof Byte)&quot;);</span>
<span class="nc" id="L150">                    return new ByteId(meta.getDescribedType(),</span>
<span class="nc bnc" id="L151" title="All 2 branches missed.">                        val == null ? 0 : ((Number) val).byteValue());</span>
                case JavaTypes.CHAR:
                case JavaTypes.CHAR_OBJ:
<span class="nc" id="L154">                    return new CharId(meta.getDescribedType(),</span>
<span class="nc bnc" id="L155" title="All 2 branches missed.">                        val == null ? 0 : ((Character) val).charValue());</span>
                case JavaTypes.DOUBLE:
                case JavaTypes.DOUBLE_OBJ:
<span class="nc bnc" id="L158" title="All 4 branches missed.">                    if (!convert &amp;&amp; !(val instanceof Double))</span>
<span class="nc" id="L159">                        throw new ClassCastException(&quot;!(x instanceof Double)&quot;);</span>
<span class="nc" id="L160">                    return new DoubleId(meta.getDescribedType(),</span>
<span class="nc bnc" id="L161" title="All 2 branches missed.">                        val == null ? 0 : ((Number) val).doubleValue());</span>
                case JavaTypes.FLOAT:
                case JavaTypes.FLOAT_OBJ:
<span class="nc bnc" id="L164" title="All 4 branches missed.">                    if (!convert &amp;&amp; !(val instanceof Float))</span>
<span class="nc" id="L165">                        throw new ClassCastException(&quot;!(x instanceof Float)&quot;);</span>
<span class="nc" id="L166">                    return new FloatId(meta.getDescribedType(),</span>
<span class="nc bnc" id="L167" title="All 2 branches missed.">                        val == null ? 0 : ((Number) val).floatValue());</span>
                case JavaTypes.INT:
                case JavaTypes.INT_OBJ:
<span class="nc bnc" id="L170" title="All 4 branches missed.">                    if (!convert &amp;&amp; !(val instanceof Integer))</span>
<span class="nc" id="L171">                        throw new ClassCastException(&quot;!(x instanceof Integer)&quot;);</span>
<span class="nc" id="L172">                    return new IntId(meta.getDescribedType(),</span>
<span class="nc bnc" id="L173" title="All 2 branches missed.">                        val == null ? 0 : ((Number) val).intValue());</span>
                case JavaTypes.LONG:
                case JavaTypes.LONG_OBJ:
<span class="nc bnc" id="L176" title="All 4 branches missed.">                    if (!convert &amp;&amp; !(val instanceof Long))</span>
<span class="nc" id="L177">                        throw new ClassCastException(&quot;!(x instanceof Long)&quot;);</span>
<span class="nc" id="L178">                    return new LongId(meta.getDescribedType(),</span>
<span class="nc bnc" id="L179" title="All 2 branches missed.">                        val == null ? 0 : ((Number) val).longValue());</span>
                case JavaTypes.SHORT:
                case JavaTypes.SHORT_OBJ:
<span class="nc bnc" id="L182" title="All 4 branches missed.">                    if (!convert &amp;&amp; !(val instanceof Short))</span>
<span class="nc" id="L183">                        throw new ClassCastException(&quot;!(x instanceof Short)&quot;);</span>
<span class="nc" id="L184">                    return new ShortId(meta.getDescribedType(),</span>
<span class="nc bnc" id="L185" title="All 2 branches missed.">                        val == null ? 0 : ((Number) val).shortValue());</span>
                case JavaTypes.STRING:
<span class="nc" id="L187">                    return new StringId(meta.getDescribedType(), (String) val);</span>
                case JavaTypes.DATE:
<span class="nc" id="L189">                    return new DateId(meta.getDescribedType(), (Date) val);</span>
                case JavaTypes.OID:
                case JavaTypes.OBJECT:
<span class="nc" id="L192">                    return new ObjectId(meta.getDescribedType(), val);</span>
                case JavaTypes.BIGDECIMAL:
<span class="nc bnc" id="L194" title="All 4 branches missed.">                    if (!convert &amp;&amp; !(val instanceof BigDecimal))</span>
<span class="nc" id="L195">                        throw new ClassCastException(</span>
                            &quot;!(x instanceof BigDecimal)&quot;);
<span class="nc" id="L197">                    return new BigDecimalId(meta.getDescribedType(),</span>
                        (BigDecimal)val);
                case JavaTypes.BIGINTEGER:
<span class="nc bnc" id="L200" title="All 4 branches missed.">                    if (!convert &amp;&amp; !(val instanceof BigInteger))</span>
<span class="nc" id="L201">                        throw new ClassCastException(</span>
                            &quot;!(x instanceof BigInteger)&quot;);
<span class="nc" id="L203">                    return new BigIntegerId(meta.getDescribedType(),</span>
                        (BigInteger)val);
                case JavaTypes.BOOLEAN:
                case JavaTypes.BOOLEAN_OBJ:
<span class="nc bnc" id="L207" title="All 4 branches missed.">                    if (!convert &amp;&amp; !(val instanceof Boolean))</span>
<span class="nc" id="L208">                        throw new ClassCastException(&quot;!(x instanceof Boolean)&quot;);</span>
<span class="nc" id="L209">                    return new BooleanId(meta.getDescribedType(),</span>
<span class="nc bnc" id="L210" title="All 2 branches missed.">                        val == null ? false : (Boolean)val);</span>
                default:
<span class="nc" id="L212">                    throw new InternalException();</span>
            }
        }

        // copy pks to oid
<span class="nc bnc" id="L217" title="All 2 branches missed.">        if (!Modifier.isAbstract(meta.getDescribedType().getModifiers())) {</span>
<span class="nc" id="L218">            Object oid = PCRegistry.newObjectId(meta.getDescribedType());</span>
<span class="nc" id="L219">            PrimaryKeyFieldManager producer = new PrimaryKeyFieldManager();</span>
<span class="nc" id="L220">            producer.setStore(pks);</span>
<span class="nc bnc" id="L221" title="All 2 branches missed.">            if (convert)</span>
<span class="nc" id="L222">                producer.setMetaData(meta);</span>
<span class="nc" id="L223">            PCRegistry.copyKeyFieldsToObjectId(meta.getDescribedType(),</span>
                producer, oid);
<span class="nc" id="L225">            return ApplicationIds.wrap(meta, oid);</span>
        }

        // default to reflection
<span class="nc" id="L229">        Class&lt;?&gt; oidType = meta.getObjectIdType();</span>
<span class="nc bnc" id="L230" title="All 2 branches missed.">        if (Modifier.isAbstract(oidType.getModifiers()))</span>
<span class="nc" id="L231">            throw new UserException(_loc.get(&quot;objectid-abstract&quot;, meta));</span>
<span class="nc" id="L232">        Object copy = null;</span>
        try {
<span class="nc" id="L234">            copy = AccessController.doPrivileged(</span>
<span class="nc" id="L235">                J2DoPrivHelper.newInstanceAction(oidType));</span>
<span class="nc" id="L236">        } catch (Throwable t) {</span>
<span class="nc bnc" id="L237" title="All 2 branches missed.">            if (t instanceof PrivilegedActionException)</span>
<span class="nc" id="L238">                t = ((PrivilegedActionException) t).getException();</span>
<span class="nc" id="L239">            throw new GeneralException(t);</span>
<span class="nc" id="L240">        }</span>

<span class="nc" id="L242">        FieldMetaData[] fmds = meta.getPrimaryKeyFields();</span>
        Object val;
<span class="nc bnc" id="L244" title="All 2 branches missed.">        for (int i = 0; i &lt; fmds.length; i++) {</span>
<span class="nc bnc" id="L245" title="All 2 branches missed.">            val = (convert) ? JavaTypes.convert(pks[i],</span>
<span class="nc" id="L246">                fmds[i].getObjectIdFieldTypeCode()) : pks[i];</span>
<span class="nc bnc" id="L247" title="All 2 branches missed.">            if (AccessCode.isField(meta.getAccessType()))</span>
<span class="nc" id="L248">                Reflection.set(copy, Reflection.findField(oidType,</span>
<span class="nc" id="L249">                    fmds[i].getName(), true), val);</span>
            else
<span class="nc" id="L251">                Reflection.set(copy, Reflection.findSetter(oidType,</span>
<span class="nc" id="L252">                    fmds[i].getName(), fmds[i].getDeclaredType(), true), val);</span>
        }

<span class="nc bnc" id="L255" title="All 2 branches missed.">        if (meta.isObjectIdTypeShared())</span>
<span class="nc" id="L256">            copy = new ObjectId(meta.getDescribedType(), copy);</span>
<span class="nc" id="L257">        return copy;</span>
    }

    /**
     * Copy the given oid value.
     */
    public static Object copy(Object oid, ClassMetaData meta) {
<span class="nc bnc" id="L264" title="All 4 branches missed.">        if (meta == null || oid == null)</span>
<span class="nc" id="L265">            return null;</span>

<span class="nc bnc" id="L267" title="All 2 branches missed.">        if (meta.isOpenJPAIdentity()) {</span>
            // use meta type instead of oid type in case it's a subclass
<span class="nc" id="L269">            Class&lt;?&gt; cls = meta.getDescribedType();</span>
<span class="nc" id="L270">            OpenJPAId koid = (OpenJPAId) oid;</span>
<span class="nc" id="L271">            FieldMetaData pk = meta.getPrimaryKeyFields()[0];</span>
<span class="nc bnc" id="L272" title="All 14 branches missed.">            switch (pk.getObjectIdFieldTypeCode()) {</span>
                case JavaTypes.BYTE:
                case JavaTypes.BYTE_OBJ:
<span class="nc" id="L275">                    return new ByteId(cls, ((ByteId) oid).getId(),</span>
<span class="nc" id="L276">                        koid.hasSubclasses());</span>
                case JavaTypes.CHAR:
                case JavaTypes.CHAR_OBJ:
<span class="nc" id="L279">                    return new CharId(cls, ((CharId) oid).getId(),</span>
<span class="nc" id="L280">                        koid.hasSubclasses());</span>
                case JavaTypes.DOUBLE:
                case JavaTypes.DOUBLE_OBJ:
<span class="nc" id="L283">                    return new DoubleId(cls, ((DoubleId) oid).getId(),</span>
<span class="nc" id="L284">                        koid.hasSubclasses());</span>
                case JavaTypes.FLOAT:
                case JavaTypes.FLOAT_OBJ:
<span class="nc" id="L287">                    return new FloatId(cls, ((FloatId) oid).getId(),</span>
<span class="nc" id="L288">                        koid.hasSubclasses());</span>
                case JavaTypes.INT:
                case JavaTypes.INT_OBJ:
<span class="nc" id="L291">                    return new IntId(cls, ((IntId) oid).getId(),</span>
<span class="nc" id="L292">                        koid.hasSubclasses());</span>
                case JavaTypes.LONG:
                case JavaTypes.LONG_OBJ:
<span class="nc" id="L295">                    return new LongId(cls, ((LongId) oid).getId(),</span>
<span class="nc" id="L296">                        koid.hasSubclasses());</span>
                case JavaTypes.SHORT:
                case JavaTypes.SHORT_OBJ:
<span class="nc" id="L299">                    return new ShortId(cls, ((ShortId) oid).getId(),</span>
<span class="nc" id="L300">                        koid.hasSubclasses());</span>
                case JavaTypes.STRING:
<span class="nc" id="L302">                    return new StringId(cls, oid.toString(),</span>
<span class="nc" id="L303">                        koid.hasSubclasses());</span>
                case JavaTypes.OID:
<span class="nc" id="L305">                    ClassMetaData embed = pk.getEmbeddedMetaData();</span>
<span class="nc" id="L306">                    Object inner = koid.getIdObject();</span>
<span class="nc bnc" id="L307" title="All 2 branches missed.">                    if (embed != null)</span>
<span class="nc" id="L308">                        inner = copy(inner, embed, embed.getFields());</span>
<span class="nc" id="L309">                    return new ObjectId(cls, inner, koid.hasSubclasses());</span>
                case JavaTypes.OBJECT:
<span class="nc" id="L311">                    return new ObjectId(cls, koid.getIdObject(),</span>
<span class="nc" id="L312">                        koid.hasSubclasses());</span>
                case JavaTypes.DATE:
<span class="nc" id="L314">                    return new DateId(cls, ((DateId) oid).getId(),</span>
<span class="nc" id="L315">                        koid.hasSubclasses());</span>
                case JavaTypes.BIGDECIMAL:
<span class="nc" id="L317">                    return new BigDecimalId(cls, ((BigDecimalId) oid).getId(),</span>
<span class="nc" id="L318">                        koid.hasSubclasses());</span>
                case JavaTypes.BIGINTEGER:
<span class="nc" id="L320">                    return new BigIntegerId(cls, ((BigIntegerId) oid).getId(),</span>
<span class="nc" id="L321">                        koid.hasSubclasses());</span>
                default:
<span class="nc" id="L323">                    throw new InternalException();</span>
            }
        }

        // create a new pc instance of the right type, set its key fields
        // to the original oid values, then copy its key fields to a new
        // oid instance
<span class="nc bnc" id="L330" title="All 2 branches missed.">        if (!Modifier.isAbstract(meta.getDescribedType().getModifiers())</span>
<span class="nc bnc" id="L331" title="All 2 branches missed.">            &amp;&amp; !hasPCPrimaryKeyFields(meta)) {</span>
<span class="nc" id="L332">            Class&lt;?&gt; type = meta.getDescribedType();</span>
<span class="nc" id="L333">            PersistenceCapable pc = PCRegistry.newInstance(type, null, oid,</span>
                 false);
<span class="nc" id="L335">            Object copy = pc.pcNewObjectIdInstance();</span>
<span class="nc" id="L336">            pc.pcCopyKeyFieldsToObjectId(copy);</span>
<span class="nc" id="L337">            return copy;</span>
        }

<span class="nc bnc" id="L340" title="All 2 branches missed.">        Object copy = (!meta.isObjectIdTypeShared()) ? oid</span>
<span class="nc" id="L341">            : ((ObjectId) oid).getId();</span>
<span class="nc" id="L342">        copy = copy(copy, meta, meta.getPrimaryKeyFields());</span>
<span class="nc bnc" id="L343" title="All 2 branches missed.">        if (meta.isObjectIdTypeShared())</span>
<span class="nc" id="L344">            copy = new ObjectId(meta.getDescribedType(), copy,</span>
<span class="nc" id="L345">                ((OpenJPAId) oid).hasSubclasses());</span>
<span class="nc" id="L346">        return copy;</span>
    }

    /**
     * Return true if any of the given type's primary key fields are
     * persistent objects.
     */
    private static boolean hasPCPrimaryKeyFields(ClassMetaData meta) {
<span class="nc" id="L354">        FieldMetaData[] fmds = meta.getPrimaryKeyFields();</span>
<span class="nc bnc" id="L355" title="All 2 branches missed.">        for (int i = 0; i &lt; fmds.length; i++)</span>
<span class="nc bnc" id="L356" title="All 2 branches missed.">            if (fmds[i].getDeclaredTypeCode() == JavaTypes.PC)</span>
<span class="nc" id="L357">                return true;</span>
<span class="nc" id="L358">        return false;</span>
    }

    /**
     * Copy the given identity object using reflection.
     */
    private static Object copy(Object oid, ClassMetaData meta,
        FieldMetaData[] fmds) {
<span class="nc bnc" id="L366" title="All 2 branches missed.">        if (oid == null)</span>
<span class="nc" id="L367">            return null;</span>

<span class="nc" id="L369">        Class&lt;?&gt; oidType = oid.getClass();</span>
<span class="nc" id="L370">        Object copy = null;</span>
        try {
<span class="nc" id="L372">            copy = AccessController.doPrivileged(</span>
<span class="nc" id="L373">                J2DoPrivHelper.newInstanceAction(oidType));</span>
<span class="nc" id="L374">        } catch (Throwable t) {</span>
<span class="nc bnc" id="L375" title="All 2 branches missed.">            if (t instanceof PrivilegedActionException)</span>
<span class="nc" id="L376">                t = ((PrivilegedActionException) t).getException();</span>
<span class="nc" id="L377">            throw new GeneralException(t);</span>
<span class="nc" id="L378">        }</span>

        Field field;
        Object val;
<span class="nc bnc" id="L382" title="All 2 branches missed.">        for (int i = 0; i &lt; fmds.length; i++) {</span>
<span class="nc bnc" id="L383" title="All 2 branches missed.">            if (fmds[i].getManagement() != FieldMetaData.MANAGE_PERSISTENT)</span>
<span class="nc" id="L384">                continue;</span>

<span class="nc bnc" id="L386" title="All 2 branches missed.">            if (AccessCode.isField(meta.getAccessType())) {</span>
<span class="nc" id="L387">                    field = Reflection.findField(oidType, fmds[i].getName(),</span>
                        true);
<span class="nc" id="L389">                    Reflection.set(copy, field, Reflection.get(oid, field));</span>
                } else { // property
<span class="nc" id="L391">                    val = Reflection.get(oid, Reflection.findGetter(oidType,</span>
<span class="nc" id="L392">                        fmds[i].getName(), true));</span>
<span class="nc" id="L393">                    Reflection.set(copy, Reflection.findSetter(oidType, fmds[i].</span>
<span class="nc" id="L394">                        getName(), fmds[i].getObjectIdFieldType(), true), val);</span>
                }
            }
<span class="nc" id="L397">            return copy;</span>
    }

    /**
     * Return the given primary key field value from the given oid.
     */
    public static Object get(Object oid, FieldMetaData fmd) {
<span class="nc bnc" id="L404" title="All 2 branches missed.">        if (oid == null)</span>
<span class="nc" id="L405">            return null;</span>
<span class="nc bnc" id="L406" title="All 2 branches missed.">        if (oid instanceof OpenJPAId)</span>
<span class="nc" id="L407">            return ((OpenJPAId) oid).getIdObject();</span>

<span class="nc" id="L409">        ClassMetaData meta = fmd.getDefiningMetaData();</span>
<span class="nc" id="L410">        Class&lt;?&gt; oidType = oid.getClass();</span>
<span class="nc bnc" id="L411" title="All 2 branches missed.">        if (AccessCode.isField(meta.getAccessType()))</span>
<span class="nc" id="L412">            return Reflection.get(oid, Reflection.findField(oidType,</span>
<span class="nc" id="L413">                fmd.getName(), true));</span>
<span class="nc" id="L414">        return Reflection.get(oid, Reflection.findGetter(oidType, fmd.getName(),</span>
            true));
    }

    /**
     * Generate an application id based on the current primary key field state
     * of the given instance.
     */
    public static Object create(PersistenceCapable pc, ClassMetaData meta) {
<span class="nc bnc" id="L423" title="All 2 branches missed.">        if (pc == null)</span>
<span class="nc" id="L424">            return null;</span>

<span class="nc" id="L426">        Object oid = pc.pcNewObjectIdInstance();</span>
<span class="nc bnc" id="L427" title="All 2 branches missed.">        if (oid == null)</span>
<span class="nc" id="L428">            return null;</span>

<span class="nc bnc" id="L430" title="All 2 branches missed.">        if (!meta.isOpenJPAIdentity()) {</span>
<span class="nc" id="L431">            pc.pcCopyKeyFieldsToObjectId(oid);</span>
<span class="nc" id="L432">            return oid;</span>
        }

<span class="nc" id="L435">        FieldMetaData pk = meta.getPrimaryKeyFields()[0];</span>
<span class="nc bnc" id="L436" title="All 2 branches missed.">        if (pk.getDeclaredTypeCode() != JavaTypes.OID)</span>
<span class="nc" id="L437">            return oid;</span>

        // always copy oid object in case field value mutates or becomes
        // managed
<span class="nc" id="L441">        ObjectId objid = (ObjectId) oid;</span>
<span class="nc" id="L442">        ClassMetaData embed = pk.getEmbeddedMetaData();</span>
<span class="nc" id="L443">        objid.setId(copy(objid.getId(), embed, embed.getFields()));</span>
<span class="nc" id="L444">        return objid;</span>
    }

    /**
     * Assign an application identity object to the given state, or return
     * false if determining the application identity requires a flush.
     */
    public static boolean assign(OpenJPAStateManager sm, StoreManager store,
        boolean preFlush) {
<span class="nc" id="L453">        ClassMetaData meta = sm.getMetaData();</span>
<span class="nc bnc" id="L454" title="All 2 branches missed.">        if (meta.getIdentityType() != ClassMetaData.ID_APPLICATION)</span>
<span class="nc" id="L455">            throw new InternalException();</span>

        boolean ret;
<span class="nc" id="L458">        FieldMetaData[] pks = meta.getPrimaryKeyFields();</span>
<span class="nc bnc" id="L459" title="All 2 branches missed.">        if (meta.isOpenJPAIdentity()</span>
<span class="nc bnc" id="L460" title="All 2 branches missed.">            &amp;&amp; pks[0].getDeclaredTypeCode() == JavaTypes.OID) {</span>
<span class="nc" id="L461">            OpenJPAStateManager oidsm = new ObjectIdStateManager</span>
<span class="nc" id="L462">                (sm.fetchObjectField(pks[0].getIndex()), sm, pks[0]);</span>
<span class="nc" id="L463">            ret = assign(oidsm, store, pks[0].getEmbeddedMetaData().</span>
<span class="nc" id="L464">                getFields(), preFlush);</span>
<span class="nc" id="L465">            sm.storeObjectField(pks[0].getIndex(),</span>
<span class="nc" id="L466">                oidsm.getManagedInstance());</span>
<span class="nc" id="L467">        } else</span>
<span class="nc" id="L468">            ret = assign(sm, store, meta.getPrimaryKeyFields(), preFlush);</span>
<span class="nc bnc" id="L469" title="All 2 branches missed.">        if (!ret)</span>
<span class="nc" id="L470">            return false;</span>

        // base oid on field values
<span class="nc" id="L473">        sm.setObjectId(create(sm.getPersistenceCapable(), meta));</span>
<span class="nc" id="L474">        return true;</span>
    }

    /**
     * Assign generated values to given primary key fields.
     */
    private static boolean assign(OpenJPAStateManager sm, StoreManager store,
        FieldMetaData[] pks, boolean preFlush) {
<span class="nc bnc" id="L482" title="All 2 branches missed.">        for (int i = 0; i &lt; pks.length; i++)</span>
            // If we are generating values...
<span class="nc bnc" id="L484" title="All 2 branches missed.">            if (pks[i].getValueStrategy() != ValueStrategies.NONE) {</span>
                // If a value already exists on this field, throw exception.
                // This is considered an application coding error.
<span class="nc bnc" id="L487" title="All 2 branches missed.">                if (!sm.isDefaultValue(pks[i].getIndex()))</span>
<span class="nc" id="L488">                    throw new InvalidStateException(_loc2.get(&quot;existing-value-override-excep&quot;,</span>
<span class="nc" id="L489">                            pks[i].getFullName(false), Exceptions.toString(sm.getPersistenceCapable()),</span>
<span class="nc" id="L490">                            sm.getPCState().getClass().getSimpleName()));</span>
                // Assign the generated value
<span class="nc bnc" id="L492" title="All 2 branches missed.">                if (store.assignField(sm, pks[i].getIndex(), preFlush))</span>
<span class="nc" id="L493">                    pks[i].setValueGenerated(true);</span>
                else
<span class="nc" id="L495">                    return false;</span>
            }
<span class="nc" id="L497">        return true;</span>
    }

    /**
     * Check if object id is set or not.
     */
    public static boolean isIdSet(Object id, ClassMetaData meta,
        String mappedByIdFieldName) {
<span class="nc" id="L505">        Object key = null;</span>
<span class="nc bnc" id="L506" title="All 2 branches missed.">        if (meta.isOpenJPAIdentity())</span>
<span class="nc" id="L507">            key = ApplicationIds.getKey(id, meta);</span>
        else
<span class="nc" id="L509">            key = ((ObjectId)id).getId();</span>
<span class="nc" id="L510">        Object val = null;</span>
<span class="nc bnc" id="L511" title="All 2 branches missed.">        if (mappedByIdFieldName.length() != 0) {</span>
<span class="nc bnc" id="L512" title="All 2 branches missed.">            if (((ObjectId)id).getId() == null)</span>
<span class="nc" id="L513">                return false;</span>
<span class="nc" id="L514">            Class&lt;?&gt; idClass = ((ObjectId)id).getId().getClass();</span>
<span class="nc" id="L515">            val = Reflection.get(key,</span>
<span class="nc" id="L516">                    Reflection.findField(idClass, mappedByIdFieldName, true));</span>
<span class="nc" id="L517">        } else</span>
<span class="nc" id="L518">            val = key;</span>

<span class="nc bnc" id="L520" title="All 4 branches missed.">        boolean notSet = (val == null</span>
<span class="nc bnc" id="L521" title="All 4 branches missed.">                || (val instanceof String &amp;&amp; ((String)val).length() == 0)</span>
<span class="nc bnc" id="L522" title="All 2 branches missed.">                || (val instanceof Number &amp;&amp; ((Number)val).longValue() == 0));</span>
<span class="nc bnc" id="L523" title="All 2 branches missed.">        return !notSet;</span>
    }

    /**
     * Return the key from the given id.
     */
    public static Object getKey(Object id, ClassMetaData meta) {
<span class="nc bnc" id="L530" title="All 4 branches missed.">        if (meta == null || id == null)</span>
<span class="nc" id="L531">            return null;</span>

<span class="nc bnc" id="L533" title="All 2 branches missed.">        if (meta.isOpenJPAIdentity()) {</span>
<span class="nc" id="L534">            int type = meta.getPrimaryKeyFields()[0].getObjectIdFieldTypeCode();</span>
<span class="nc bnc" id="L535" title="All 13 branches missed.">            switch (type) {</span>
                case JavaTypes.BYTE:
                case JavaTypes.BYTE_OBJ:
<span class="nc" id="L538">                    return ((ByteId)id).getId();</span>
                case JavaTypes.CHAR:
                case JavaTypes.CHAR_OBJ:
<span class="nc" id="L541">                    return ((CharId)id).getId();</span>
                case JavaTypes.DOUBLE:
                case JavaTypes.DOUBLE_OBJ:
<span class="nc" id="L544">                    return ((DoubleId)id).getId();</span>
                case JavaTypes.FLOAT:
                case JavaTypes.FLOAT_OBJ:
<span class="nc" id="L547">                    return ((FloatId)id).getId();</span>
                case JavaTypes.INT:
                case JavaTypes.INT_OBJ:
<span class="nc" id="L550">                    return ((IntId)id).getId();</span>
                case JavaTypes.LONG:
                case JavaTypes.LONG_OBJ:
<span class="nc" id="L553">                    return ((LongId)id).getId();</span>
                case JavaTypes.SHORT:
                case JavaTypes.SHORT_OBJ:
<span class="nc" id="L556">                    return ((ShortId)id).getId();</span>
                case JavaTypes.STRING:
<span class="nc" id="L558">                    return ((StringId)id).getId();</span>
                case JavaTypes.DATE:
<span class="nc" id="L560">                    return ((DateId)id).getId();</span>
                case JavaTypes.OID:
                case JavaTypes.OBJECT:
<span class="nc" id="L563">                    return ((ObjectId)id).getId();</span>
                case JavaTypes.BIGDECIMAL:
<span class="nc" id="L565">                    return ((BigDecimalId)id).getId();</span>
                case JavaTypes.BIGINTEGER:
<span class="nc" id="L567">                    return ((BigIntegerId)id).getId();</span>
                default:
<span class="nc" id="L569">                    throw new InternalException();</span>
            }
        } else { // IdClass
<span class="nc" id="L572">            return ((ObjectId)id).getId();</span>
        }

    }

    /**
     * Sets the underlying id of an ObjectId.  Should only
     * be used with simple (idclass) types.
     */
    public static void setAppId(ObjectId id, Object newId) {
<span class="nc" id="L582">        id.setId(newId);</span>
<span class="nc" id="L583">    }</span>

    /**
     * Helper class used to transfer pk values to/from application oids.
     */
<span class="nc" id="L588">    private static class PrimaryKeyFieldManager</span>
        implements FieldManager {

<span class="nc" id="L591">        private Object[] _store = null;</span>
<span class="nc" id="L592">        private int _index = 0;</span>
<span class="nc" id="L593">        private ClassMetaData _meta = null;</span>

        public void setMetaData(ClassMetaData meta) {
<span class="nc" id="L596">            _meta = meta;</span>
<span class="nc" id="L597">        }</span>

        public Object[] getStore() {
<span class="nc" id="L600">            return _store;</span>
        }

        public void setStore(Object[] store) {
<span class="nc" id="L604">            _store = store;</span>
<span class="nc" id="L605">        }</span>

        @Override
        public void storeBooleanField(int field, boolean val) {
<span class="nc bnc" id="L609" title="All 2 branches missed.">            store((val) ? Boolean.TRUE : Boolean.FALSE);</span>
<span class="nc" id="L610">        }</span>

        @Override
        public void storeByteField(int field, byte val) {
<span class="nc" id="L614">            store(Byte.valueOf(val));</span>
<span class="nc" id="L615">        }</span>

        @Override
        public void storeCharField(int field, char val) {
<span class="nc" id="L619">            store(Character.valueOf(val));</span>
<span class="nc" id="L620">        }</span>

        @Override
        public void storeShortField(int field, short val) {
<span class="nc" id="L624">            store(Short.valueOf(val));</span>
<span class="nc" id="L625">        }</span>

        @Override
        public void storeIntField(int field, int val) {
<span class="nc" id="L629">            store(val);</span>
<span class="nc" id="L630">        }</span>

        @Override
        public void storeLongField(int field, long val) {
<span class="nc" id="L634">            store(val);</span>
<span class="nc" id="L635">        }</span>

        @Override
        public void storeFloatField(int field, float val) {
<span class="nc" id="L639">            store(Float.valueOf(val));</span>
<span class="nc" id="L640">        }</span>

        @Override
        public void storeDoubleField(int field, double val) {
<span class="nc" id="L644">            store(Double.valueOf(val));</span>
<span class="nc" id="L645">        }</span>

        @Override
        public void storeStringField(int field, String val) {
<span class="nc" id="L649">            store(val);</span>
<span class="nc" id="L650">        }</span>

        @Override
        public void storeObjectField(int field, Object val) {
<span class="nc" id="L654">            store(val);</span>
<span class="nc" id="L655">        }</span>

        @Override
        public boolean fetchBooleanField(int field) {
<span class="nc bnc" id="L659" title="All 2 branches missed.">            return (retrieve(field) == Boolean.TRUE) ? true : false;</span>
        }

        @Override
        public char fetchCharField(int field) {
<span class="nc" id="L664">            return ((Character) retrieve(field)).charValue();</span>
        }

        @Override
        public byte fetchByteField(int field) {
<span class="nc" id="L669">            return ((Number) retrieve(field)).byteValue();</span>
        }

        @Override
        public short fetchShortField(int field) {
<span class="nc" id="L674">            return ((Number) retrieve(field)).shortValue();</span>
        }

        @Override
        public int fetchIntField(int field) {
<span class="nc" id="L679">            return ((Number) retrieve(field)).intValue();</span>
        }

        @Override
        public long fetchLongField(int field) {
<span class="nc" id="L684">            return ((Number) retrieve(field)).longValue();</span>
        }

        @Override
        public float fetchFloatField(int field) {
<span class="nc" id="L689">            return ((Number) retrieve(field)).floatValue();</span>
        }

        @Override
        public double fetchDoubleField(int field) {
<span class="nc" id="L694">            return ((Number) retrieve(field)).doubleValue();</span>
        }

        @Override
        public String fetchStringField(int field) {
<span class="nc" id="L699">            return (String) retrieve(field);</span>
        }

        @Override
        public Object fetchObjectField(int field) {
<span class="nc" id="L704">            return retrieve(field);</span>
        }

        private void store(Object val) {
<span class="nc" id="L708">            _store[_index++] = val;</span>
<span class="nc" id="L709">        }</span>

        private Object retrieve(int field) {
<span class="nc" id="L712">            Object val = _store[_index++];</span>
<span class="nc bnc" id="L713" title="All 2 branches missed.">            if (_meta != null) {</span>
<span class="nc" id="L714">                FieldMetaData fmd = _meta.getField(field);</span>
<span class="nc bnc" id="L715" title="All 2 branches missed.">                if (fmd.getDeclaredTypeCode() != JavaTypes.PC)</span>
<span class="nc" id="L716">                    val = JavaTypes.convert(val, fmd.getDeclaredTypeCode());</span>
                else
<span class="nc" id="L718">                    val = JavaTypes.convert(val, JavaTypes.getTypeCode(fmd.</span>
<span class="nc" id="L719">                        getObjectIdFieldType()));</span>
            }
<span class="nc" id="L721">            return val;</span>
		}
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.4.201905082037</span></div></body></html>